CREATE DATABASE QLY_CTY

USE QLY_CTY

CREATE TABLE NHAN_VIEN(
	MA_NV VARCHAR(5) NOT NULL,
	HO_NV NVARCHAR(20) NOT NULL,
	TEN_NV NVARCHAR(20) NOT NULL,
	MA_PHG VARCHAR(5) NOT NULL,
	TUOI INT NOT NULL,
	LUONG DECIMAL(18,0) NOT NULL,
)

CREATE TABLE PHONG(
	MA_PHG VARCHAR(5) NOT NULL,
	MA_CTY VARCHAR(5) NOT NULL,
	TEN_PHG NVARCHAR(20) NOT NULL,
	LOAI_PHG NVARCHAR(20) NOT NULL,
	SOLUONG_NV INT NOT NULL,
	TEN_TRUONGPHONG NVARCHAR(50) NOT NULL,
	DIADIEM NVARCHAR(50) NOT NULL,
)

CREATE TABLE CONG_TY(
	MA_CTY VARCHAR(5) NOT NULL,
	TEN_CTY NVARCHAR(50) NOT NULL,
	NGAY_THANHLAP DATE NOT NULL,
)

CREATE TABLE DEAN(
	MA_DEAN VARCHAR(5) NOT NULL,
	TEN_DEAN NVARCHAR(50) NOT NULL,
	DIADIEM NVARCHAR(50) NOT NULL,
	SOLUONG_NV INT NOT NULL,
	MA_PHG VARCHAR(5) NOT NULL,
	TG_BATDAU DATE NOT NULL,
	TG_KETTHUC DATE NOT NULL
)

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT PK_NHAN_VIEN
PRIMARY KEY (MA_NV)

ALTER TABLE PHONG
ADD CONSTRAINT PK_PHONG
PRIMARY KEY (MA_PHG)

ALTER TABLE CONG_TY
ADD CONSTRAINT PK_CONG_TY
PRIMARY KEY (MA_CTY)

ALTER TABLE DEAN
ADD CONSTRAINT PK_DEAN
PRIMARY KEY (MA_DEAN)

ALTER TABLE PHONG
ADD CONSTRAINT FK_MA_CTY
FOREIGN KEY (MA_CTY) REFERENCES CONG_TY (MA_CTY);

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT FK_MA_PHG
FOREIGN KEY (MA_PHG) REFERENCES PHONG (MA_PHG);

ALTER TABLE DEAN
ADD CONSTRAINT FK_MA_PHG_DEAN
FOREIGN KEY (MA_PHG) REFERENCES PHONG (MA_PHG);

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT CK_TUOI CHECK (TUOI >=18 AND TUOI <=64),
	CONSTRAINT CK_LUONG CHECK (LUONG >=0);
	
ALTER TABLE PHONG
ADD CONSTRAINT CK_SOLUONG CHECK (SOLUONG_NV >= 0);

ALTER TABLE CONG_TY
ADD CONSTRAINT CK_NGAY_THANHLAP CHECK (NGAY_THANHLAP < CAST (GETDATE () AS DATE ));

ALTER TABLE DEAN
ADD CONSTRAINT CK_SOLUONG_NV CHECK (SOLUONG_NV >=0),
	CONSTRAINT CK_TG_BATDAU CHECK (TG_BATDAU <= CAST (GETDATE () AS DATE)),
	CONSTRAINT CK_TG_KETTHUC  CHECK (TG_KETTHUC >= CAST (GETDATE () AS DATE));

INSERT INTO CONG_TY (MA_CTY, TEN_CTY, NGAY_THANHLAP) VALUES
('CT001', N'Công ty ISOVN', '2010-05-01'),
('CT002', N'Công ty TechGen', '2015-09-12'),
('CT003', N'Công ty Xanh Sạch', '2018-03-20');

INSERT INTO PHONG (MA_PHG, MA_CTY, TEN_PHG, LOAI_PHG, SOLUONG_NV, TEN_TRUONGPHONG, DIADIEM) VALUES
('P001', 'CT001', N'Phòng Hành Chính', N'Văn phòng', 5, N'Nguyễn Văn An', N'Tầng 3 - Trụ sở chính'),
('P002', 'CT001', N'Phòng Kỹ Thuật', N'Kỹ thuật', 8, N'Lê Thị Bình', N'Tầng 4 - Tòa nhà ISOVN'),
('P003', 'CT002', N'Phòng Kế Toán', N'Tài chính', 4, N'Trần Văn Cường', N'Văn phòng TP.HCM'),
('P004', 'CT003', N'Phòng Marketing', N'Truyền thông', 6, N'Phạm Thị Dung', N'Tầng 2 - Cơ sở Hà Nội');

INSERT INTO NHAN_VIEN (MA_NV, HO_NV, TEN_NV, MA_PHG, TUOI, LUONG) VALUES
('NV001', N'Nguyễn', N'Thành', 'P001', 29, 12000000),
('NV002', N'Lê', N'Quỳnh', 'P001', 34, 11000000),
('NV003', N'Phạm', N'Tú', 'P002', 27, 15000000),
('NV004', N'Trần', N'An', 'P002', 31, 14500000),
('NV005', N'Hoàng', N'Mai', 'P003', 26, 10000000),
('NV006', N'Vũ', N'Thảo', 'P003', 39, 12500000),
('NV007', N'Đặng', N'Linh', 'P004', 30, 13000000),
('NV008', N'Bùi', N'Trung', 'P004', 28, 12800000);

INSERT INTO DEAN (MA_DEAN, TEN_DEAN, DIADIEM, SOLUONG_NV, MA_PHG, TG_BATDAU, TG_KETTHUC) VALUES
('DA001', N'Dự án ERP', N'Hà Nội', 4, 'P001', '2023-01-01', '2025-06-30'),
('DA002', N'Dự án AI', N'TP.HCM', 5, 'P002', '2023-05-15', '2025-12-18'),
('DA003', N'Dự án Kế toán số', N'TP.HCM', 2, 'P003', '2022-11-01', '2025-12-31'),
('DA004', N'Dự án Truyền thông', N'Hà Nội', 3, 'P004', '2024-02-01', '2025-05-31');


CREATE VIEW VIEW_HOTEN_PHG AS
SELECT 
    NV.HO_NV,
    NV.TEN_NV,
    P.TEN_PHG,
    P.DIADIEM
FROM NHAN_VIEN NV
JOIN PHONG P ON NV.MA_PHG = P.MA_PHG;

SELECT * FROM VIEW_HOTEN_PHG

CREATE VIEW NHANVIEN_CTY AS
SELECT 
	NV.HO_NV + ' ' + NV.TEN_NV AS HOTEN,
	NV.LUONG,
	NV.TUOI
FROM NHAN_VIEN NV

SELECT * FROM NHANVIEN_CTY

CREATE VIEW VIEW_PHG_DONGNV AS
SELECT TOP 1
	P.TEN_PHG,
	P.TEN_TRUONGPHONG,
	P.SOLUONG_NV
FROM PHONG P
ORDER BY P.SOLUONG_NV DESC

SELECT * FROM VIEW_PHG_DONGNV

CREATE PROC XIN_CHAO
	@TEN NVARCHAR(50)
AS
BEGIN
	PRINT N'Xin chào ' + @TEN;
END

EXEC XIN_CHAO N'Nguyễn Anh Dương';

CREATE PROC TONG
	@SO1 INT,
	@SO2 INT
AS
BEGIN
	DECLARE @TONG INT;
	SET @TONG = @SO1 + @SO2;
	PRINT N'Tổng = ' + CAST (@TONG AS NVARCHAR);
END;

EXEC TONG 12,24;

CREATE PROC TONGCHAN
	@N INT
AS
BEGIN
	DECLARE @I INT = 2;
	DECLARE @TONG INT = 0;
	WHILE @I <= @N
	BEGIN
		SET @TONG = @TONG + @I;
		SET @I = @I+2;
	END;
	PRINT N'Tổng các số chẵn từ 1 đến ' + CAST(@N AS NVARCHAR) + N' Là: ' + CAST(@TONG AS NVARCHAR);
END;

EXEC TONGCHAN 12;

CREATE PROC UCLN
	@A INT,
	@B INT
AS
BEGIN 
	DECLARE @aTemp INT, @bTemp INT, @r INT;
	IF @A <@B
	BEGIN
		SET @aTemp = @A;
		SET @bTemp = @B;
	END;
	ELSE
	BEGIN
		SET @aTemp = @B;
		SET @bTemp = @A;
	END;

	WHILE @aTemp != 0 
	BEGIN
		SET @R = @bTemp % @aTemp;
		SET @bTemp = @aTemp;
		SET @aTemp = @r;
	END;

	PRINT N'UCLN của ' + CAST(@A AS NVARCHAR) + N' và ' + CAST(@B AS NVARCHAR) + N' Là ' + CAST(@bTemp AS NVARCHAR);

END;

EXEC UCLN 8, 12;

CREATE PROC XUATMA_NV
	@MANV VARCHAR(5)
AS
BEGIN 
	SELECT 
		MA_NV,
		HO_NV,
		TEN_NV,
		MA_PHG,
		TUOI,
		LUONG
	FROM NHAN_VIEN
	WHERE MA_NV = @MANV;
END

EXEC XUATMA_NV 'NV001';

CREATE PROC SO_VN_THANGIA_DA
	@MADA VARCHAR(5)
AS 
BEGIN 
	SELECT
		SOLUONG_NV
	FROM DEAN 
	WHERE MA_DEAN = @MADA;
END

EXEC SO_VN_THANGIA_DA 'DA002'

CREATE PROC SO_VN_THANGIA_DA_DIADIEM
	@MADA VARCHAR(5),
	@DDIEN_DA NVARCHAR(50)
AS 
BEGIN 
	SELECT
		SOLUONG_NV
	FROM DEAN 
	WHERE MA_DEAN = @MADA AND DIADIEM = @DDIEN_DA;
END

EXEC SO_VN_THANGIA_DA_DIADIEM 'DA001', N'Hà Nội';

CREATE PROC NHANVIEN_TPHONG
	@TRPHG NVARCHAR(50)
AS 
BEGIN
	SELECT 
		NV.MA_NV,NV.HO_NV + ' ' +NV.TEN_NV AS 'HO TEN NV',NV.TUOI,NV.LUONG,NV.MA_PHG
	FROM PHONG P
	JOIN NHAN_VIEN NV ON NV.MA_PHG = P.MA_PHG
	WHERE P.TEN_TRUONGPHONG = @TRPHG;
END;

EXEC NHANVIEN_TPHONG N'Nguyễn Văn An'

CREATE PROC KT_NV_THUOCPHONG
    @Manv VARCHAR(5),
    @Mapb VARCHAR(5)
AS
BEGIN
    DECLARE @Count INT;

    SELECT @Count = COUNT(*)
    FROM NHAN_VIEN
    WHERE MA_NV = @Manv AND MA_PHG = @Mapb;

    IF @Count > 0
    BEGIN
        PRINT N'Nhân viên ' + @Manv + N' thuộc phòng ban ' + @Mapb + N'.';
    END
    ELSE
    BEGIN
        PRINT N'Nhân viên ' + @Manv + N' không thuộc phòng ban ' + @Mapb + N'.';
    END
END;

EXEC KT_NV_THUOCPHONG 'NV001','P002'


CREATE PROC ThemPhongBanCNTT
    @MA_PHG VARCHAR(5),
    @MA_CTY VARCHAR(5),
    @TEN_PHG NVARCHAR(20),
    @LOAI_PHG NVARCHAR(20),
    @TEN_TRUONGPHONG NVARCHAR(50),
    @DIADIEM NVARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON; 

    IF EXISTS (SELECT 1 FROM PHONG WHERE MA_PHG = @MA_PHG)
    BEGIN
        PRINT N'Lỗi: Mã phòng ' + @MA_PHG + N' đã tồn tại. Thêm phòng ban thất bại.';
        RETURN; 
    END
    ELSE
    BEGIN
        INSERT INTO PHONG (MA_PHG, MA_CTY, TEN_PHG, LOAI_PHG, SOLUONG_NV, TEN_TRUONGPHONG, DIADIEM)
        VALUES (@MA_PHG, @MA_CTY, @TEN_PHG, @LOAI_PHG, 0, @TEN_TRUONGPHONG, @DIADIEM);

        PRINT N'Thêm phòng ban ' + @TEN_PHG + N' (Mã: ' + @MA_PHG + N') thành công.';
    END
END;
GO
	
 EXEC ThemPhongBanCNTT 'P005', 'CT001', N'Phòng CNTT', N'Kỹ thuật', N'Trần Văn Z', N'Tầng 5 - Tòa nhà ISOVN';

 USE QLY_CTY;
GO

CREATE PROC CapNhatTenPhongCNTT
    @TenCu NVARCHAR(20) = N'Phòng CNTT', 
    @TenMoi NVARCHAR(20) = N'Phòng IT'   
AS
BEGIN
    SET NOCOUNT ON;

    IF NOT EXISTS (SELECT 1 FROM PHONG WHERE TEN_PHG = @TenCu)
    BEGIN
        PRINT N'Lỗi: Không tìm thấy phòng ban có tên "' + @TenCu + N'".';
        RETURN;
    END
    ELSE
    BEGIN
        UPDATE PHONG
        SET TEN_PHG = @TenMoi
        WHERE TEN_PHG = @TenCu;
        IF @@ROWCOUNT > 0
            PRINT N'Đã cập nhật tên phòng ban từ "' + @TenCu + N'" thành "' + @TenMoi + N'".';
        ELSE
            PRINT N'Không có phòng ban nào được cập nhật (có thể tên đã đúng hoặc có lỗi).';
    END
END;
GO

 EXEC CapNhatTenPhongCNTT; -- Sử dụng tên mặc định 'Phòng CNTT' và 'Phòng IT'