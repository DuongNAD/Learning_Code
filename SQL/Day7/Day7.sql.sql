CREATE DATABASE QLKINHDOANH

USE QLKINHDOANH

CREATE TABLE KHACHANG(
	MA_KH VARCHAR(5) NOT NULL,
	TEN_CTY NVARCHAR(50) NOT NULL,
	TEN_GD NVARCHAR(50) NOT NULL,
	DIACHI NVARCHAR(50) NOT NULL,
	EMAIL VARCHAR(50) NOT NULL,
	DIENTHOAI VARCHAR(20) NOT NULL,
	FAX VARCHAR(20) NOT NULL,
)
	
CREATE TABLE DON_DATHANG (
	SO_HOADON VARCHAR(5) NOT NULL,
	MA_KH VARCHAR(5) NOT NULL,
	MA_NV VARCHAR(5) NOT NULL,
	NGAY_DATHANG DATE NOT NULL,
	NGAY_GIAOHANG DATE NOT NULL,
	NGAY_CHUYENHANG DATE NOT NULL,
	NOI_GIAOHANG NVARCHAR(50) NOT NULL,
)

CREATE TABLE NHAN_VIEN(
	MA_NV VARCHAR(5) NOT NULL,
	HO NVARCHAR(20) NOT NULL,
	TEN NVARCHAR(20) NOT NULL,
	NGAYSINH DATE NOT NULL,
	NGAY_LAMVIEC DATE NOT NULL,
	DIACHI NVARCHAR(50) NOT NULL,
	DIENTHOAI VARCHAR(20) NOT NULL,
	LUONG_COBAN DECIMAL(18,3) NOT NULL,
	PHUCAP DECIMAL(18,3) NOT NULL,
)

CREATE TABLE CHITIET_DATHANG (
	SO_HOADON VARCHAR(5) NOT NULL,
	MA_HANG VARCHAR(5) NOT NULL,
	GIABAN DECIMAL(18,3) NOT NULL,
	SOLUONG INT NOT NULL,
	MUC_GIAMGIA DECIMAL(18,3),
)

CREATE TABLE NHA_CUNGCAP(
	MA_CTY VARCHAR(5) NOT NULL,
	TEN_CTY NVARCHAR(50) NOT NULL,
	TEN_GIAODICH NVARCHAR(50) NOT NULL,
	DIACHI NVARCHAR(5) NOT NULL,
	DIENTHOAI VARCHAR(20) NOT NULL,
	FAX VARCHAR(20) NOT NULL,
	EMAIL VARCHAR(50) NOT NULL,
)

CREATE TABLE MATHANG(
	MA_HANG VARCHAR(5) NOT NULL,
	TENHANG NVARCHAR(50) NOT NULL,
	MA_CTY VARCHAR (5) NOT NULL,
	MA_LOAIHANG VARCHAR(5) NOT NULL,
	SOLUONG INT NOT NULL,
	DONVITINH NVARCHAR(10) NOT NULL,
	GIAHANG DECIMAL(18,3) NOT NULL,
)

CREATE TABLE LOAIHANG (
	MA_LOAIHANG VARCHAR(5) NOT NULL,
	TEN_LOAIHANG NVARCHAR(50) NOT NULL,
)
ALTER TABLE NHAN_VIEN
ALTER COLUMN LUONG_COBAN DECIMAL(18,0) NOT NULL

ALTER TABLE MATHANG
ALTER COLUMN GIAHANG DECIMAL(18,0) NOT NULL

ALTER TABLE CHITIET_DATHANG
ALTER COLUMN GIABAN DECIMAL(18,0) NOT NULL

ALTER TABLE CHITIET_DATHANG
ALTER COLUMN MUC_GIAMGIA DECIMAL(18,0)

ALTER TABLE NHAN_VIEN
ALTER COLUMN PHUCAP DECIMAL(18,0) NOT NULL

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT PK_NHAN_VIEN 
PRIMARY KEY (MA_NV)

ALTER TABLE NHA_CUNGCAP
ADD CONSTRAINT PK_NHA_CUNGCAP
PRIMARY KEY (MA_CTY)

ALTER TABLE MATHANG
ADD CONSTRAINT PK_MATHANG
PRIMARY KEY (MA_HANG)

ALTER TABLE LOAIHANG
ADD CONSTRAINT PK_LOAIHANG
PRIMARY KEY (MA_LOAIHANG)

ALTER TABLE KHACHANG
ADD CONSTRAINT PK_KHACHANG
PRIMARY KEY (MA_KH)

ALTER TABLE DON_DATHANG
ADD CONSTRAINT PK_DON_DATHANG
PRIMARY KEY (SO_HOADON)

ALTER TABLE CHITIET_DATHANG
ADD CONSTRAINT PK_CHITIET_DATHANG
PRIMARY KEY (SO_HOADON,MA_HANG)

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT CK_NGAYSINH CHECK (NGAYSINH <CAST (GETDATE () AS DATE)),
	CONSTRAINT CK_DIENTHOAI_NV CHECK (LEN(DIENTHOAI) =10),
	CONSTRAINT CK_LUONG_COBAN CHECK (LUONG_COBAN > 1000),
	CONSTRAINT CK_PHUCAP CHECK (PHUCAP >100);

ALTER TABLE NHA_CUNGCAP
ADD CONSTRAINT CK_DIENTHOAI_NHA_CUNGCAP CHECK (LEN(DIENTHOAI) =10),
	CONSTRAINT CK_FAX_NHA_CUNGCAP CHECK (LEN(FAX) BETWEEN 9 AND 11);

ALTER TABLE MATHANG
ADD CONSTRAINT CK_SOLUONG_MATHANG CHECK (SOLUONG >=0),
	CONSTRAINT CK_GIAHANG_MATHANG CHECK (GIAHANG >=0);

ALTER TABLE KHACHANG
ADD CONSTRAINT CK_DIENTHOAI_KH CHECK (LEN(DIENTHOAI) =10),
	CONSTRAINT CK_FAX_KH CHECK (LEN(FAX) BETWEEN 9 AND 11);

ALTER TABLE DON_DATHANG
ADD CONSTRAINT CK_NGAY_DATHANG CHECK (NGAY_DATHANG <=CAST (GETDATE () AS DATE)),
	CONSTRAINT CK_NGAY_GIAHANG CHECK (NGAY_GIAOHANG >=CAST (GETDATE () AS DATE)),
	CONSTRAINT CK_NGAY_CHUYENHANG CHECK (NGAY_CHUYENHANG >=CAST (GETDATE () AS DATE));

ALTER TABLE CHITIET_DATHANG
ADD CONSTRAINT CK_SOLUONG_CT_DATHANG CHECK (SOLUONG >=0),
	CONSTRAINT CK_MUC_GIAMGIA CHECK (MUC_GIAMGIA >=0),
	CONSTRAINT CK_GIABAN CHECK (GIABAN >=0);

ALTER TABLE DON_DATHANG 
ADD CONSTRAINT FK_MA_KH FOREIGN KEY (MA_KH) REFERENCES KHACHANG (MA_KH),
	CONSTRAINT FK_MA_NV FOREIGN KEY (MA_NV) REFERENCES NHAN_VIEN (MA_NV);

ALTER TABLE CHITIET_DATHANG
ADD CONSTRAINT FK_SO_HOADON FOREIGN KEY (SO_HOADON) REFERENCES DON_DATHANG (SO_HOADON),
	CONSTRAINT FK_MATHANG FOREIGN KEY (MA_HANG) REFERENCES MATHANG (MA_HANG);

ALTER TABLE MATHANG 
ADD CONSTRAINT FK_MA_CTY FOREIGN KEY (MA_CTY) REFERENCES NHA_CUNGCAP (MA_CTY),
	CONSTRAINT FK_MA_LOAIHANG FOREIGN KEY (MA_LOAIHANG) REFERENCES LOAIHANG (MA_LOAIHANG);

INSERT INTO LOAIHANG VALUES 
('LH01', N'Thực phẩm'),
('LH02', N'Đồ uống');

ALTER TABLE NHA_CUNGCAP
ALTER COLUMN DIACHI NVARCHAR(50) NOT NULL;

ALTER TABLE NHA_CUNGCAP
ALTER COLUMN FAX VARCHAR(20);

INSERT INTO NHA_CUNGCAP VALUES 
('CT01', N'Vinamilk', N'VINAMILK', N'Q1, TP.HCM', '0283838383', '02838383839', 'vinamilk@email.vn'),
('CT02', N'Công ty Thực phẩm XYZ', N'TPXYZ', N'Q3, TP.HCM', '0283777777', NULL, 'xyz@food.vn');

INSERT INTO KHACHANG VALUES
('KH01', N'Công ty TNHH ABC', N'ABC', N'Q1, TP.HCM', 'abc@gmail.com', '0912345678', '0281234567'),
('KH02', N'Công ty CP XYZ', N'XYZ', N'Q3, TP.HCM', 'xyz@gmail.com', '0987654321', '0287654321');

INSERT INTO NHAN_VIEN VALUES
('NV01', N'Nguyễn', N'An', '1990-05-01', '2020-01-01', N'Q1, TP.HCM', '0911111111', 5000, 500),
('NV02', N'Lê', N'Bình', '1992-07-15', '2021-02-01', N'Q2, TP.HCM', '0922222222', 5200, 600);

INSERT INTO MATHANG VALUES
('MH01', N'Sữa hộp XYZ', 'CT02', 'LH01', 20, N'Hộp', 150000),
('MH02', N'Nước cam Vinamilk', 'CT01', 'LH02', 100, N'Chai', 30000),
('MH03', N'Bánh quy', 'CT01', 'LH01', 40, N'Gói', 120000);

INSERT INTO DON_DATHANG VALUES
('HD01', 'KH01', 'NV01', '2025-04-20', '2025-04-23', '2025-04-24', N'Công ty ABC'),
('HD02', 'KH02', 'NV02', '2025-04-21', '2025-04-24', '2025-04-23', N'Công ty XYZ');

INSERT INTO CHITIET_DATHANG VALUES
('HD01', 'MH01', 150000, 5, 10),
('HD01', 'MH03', 120000, 2, 5),
('HD02', 'MH02', 30000, 10, 0);

SELECT * FROM NHA_CUNGCAP

SELECT MA_HANG,TENHANG,SOLUONG FROM MATHANG

SELECT HO,TEN,DIACHI,NGAY_LAMVIEC FROM NHAN_VIEN

SELECT TEN_CTY,DIACHI,DIENTHOAI FROM NHA_CUNGCAP WHERE TEN_GIAODICH ='VINAMILK'

SELECT MA_HANG,TENHANG,GIAHANG,SOLUONG FROM MATHANG
WHERE GIAHANG >100000 AND SOLUONG <50

SELECT NCC.TEN_CTY,MH.TENHANG
FROM MATHANG MH 
JOIN NHA_CUNGCAP NCC ON NCC.MA_CTY = MH.MA_CTY

SELECT NCC.TEN_CTY,MH.TENHANG
FROM MATHANG MH
JOIN NHA_CUNGCAP NCC ON NCC.MA_CTY =MH.MA_CTY
WHERE TEN_CTY = N'Công ty Thực phẩm XYZ'

SELECT NCC.TEN_CTY,NCC.DIACHI,LH.TEN_LOAIHANG
FROM NHA_CUNGCAP NCC
JOIN MATHANG MH ON MH.MA_CTY = NCC.MA_CTY
JOIN LOAIHANG LH ON MH.MA_LOAIHANG = LH.MA_LOAIHANG
WHERE LH.TEN_LOAIHANG = N'Thực phẩm';

SELECT KH.TEN_GD,MH.TENHANG
FROM KHACHANG KH
JOIN DON_DATHANG DDH ON KH.MA_KH = DDH.MA_KH
JOIN CHITIET_DATHANG CTDH ON DDH.SO_HOADON = CTDH.SO_HOADON
JOIN MATHANG MH ON MH.MA_HANG = CTDH.MA_HANG
WHERE MH.TENHANG =N'Sữa hộp XYZ'

SELECT TOP 1 
	KH.TEN_GD,NV.HO + ' ' + NV.TEN AS [TEN NHAN VIEN], DDH.NGAY_DATHANG,DDH.NGAY_CHUYENHANG,DDH.NGAY_GIAOHANG,KH.DIACHI 
FROM KHACHANG KH
JOIN DON_DATHANG DDH ON DDH.MA_KH = KH.MA_KH
JOIN NHAN_VIEN NV ON NV.MA_NV = DDH.MA_NV

SELECT
	MA_NV, HO + ' ' + TEN AS [HO TEN NHAN VIEN], LUONG_COBAN + PHUCAP AS [LUONG]
FROM NHAN_VIEN 

SELECT 
	KH.TEN_CTY, MH.TENHANG, CTDH.SOLUONG * CTDH.GIABAN - CTDH.SOLUONG * CTDH.GIABAN * CTDH.MUC_GIAMGIA /100 AS [SO TIEN PHAI TRA]
FROM KHACHANG KH
JOIN DON_DATHANG DDH ON DDH.MA_KH = KH.MA_KH
JOIN CHITIET_DATHANG CTDH ON CTDH.SO_HOADON = DDH.SO_HOADON 
JOIN MATHANG MH ON MH.MA_HANG = CTDH.MA_HANG

ALTER TABLE CHITIET_DATHANG
DROP CONSTRAINT CK_MUC_GIAMGIA

ALTER TABLE CHITIET_DATHANG
ADD CONSTRAINT CK_MUC_GIAMGIA
CHECK (MUC_GIAMGIA>=0 AND MUC_GIAMGIA <=100)

SELECT KH.MA_KH, KH.TEN_CTY AS TEN_KHACH_HANG, NCC.MA_CTY, NCC.TEN_CTY AS TEN_NHA_CUNG_CAP, KH.TEN_GD
FROM KHACHANG KH
JOIN NHA_CUNGCAP NCC ON KH.TEN_GD = NCC.TEN_GIAODICH

INSERT INTO KHACHANG
VALUES 
('KH03', N'Công ty ABC', N'ABC Co.', N'123 Đường A', 'abc@gmail.com', '0123456780','1111111111'),
('KH04', N'Công ty XYZ', N'XYZ Trading', N'456 Đường B', 'xyz@gmail.com', '0987654302','2222222222');

INSERT INTO NHA_CUNGCAP
VALUES 
('NCC03', N'Công ty DEF', N'DEF Supply', N'789 Đường C', '0321654970', NULL,'def@gmail.com'),
('NCC04', N'Công ty ABC', N'ABC Co.', N'123 Đường A','0112233450' ,NULL ,'abc@abc.com');

SELECT NV1.MA_NV AS MA_NV_1, NV1.HO + ' ' + NV1.TEN AS HO_TEN_1,
       NV2.MA_NV AS MA_NV_2, NV2.HO + ' ' + NV2.TEN AS HO_TEN_2,
       NV1.NGAYSINH
FROM NHAN_VIEN NV1
JOIN NHAN_VIEN NV2 ON NV1.NGAYSINH = NV2.NGAYSINH AND NV1.MA_NV < NV2.MA_NV

INSERT INTO NHAN_VIEN 
VALUES 
('NV03', 'Nguyen', 'An', '1990-05-15', '2015-06-01','Hà Nội 12 Láng Hạ', '0123456789', '2000000','500000'),
('NV04', 'Tran', 'Binh', '1990-05-15', '2016-07-15','Hồ Chí Minh 23 Pasteur', '0987654321','3500000','600000' ),
('NV05', 'Le', 'Cuc', '1988-08-20',  '2017-03-10','Đà Nẵng 56 Trưng Nữ Vương', '0911223344','4600000','400000'),
('NV06', 'Hoang', 'Dung', '1985-12-30', '2018-01-05','Cần Thơ 78 Nguyễn Trãi', '0933445566','5300000','700000');

SELECT  DDH.SO_HOADON, KH.TEN_CTY
FROM DON_DATHANG DDH
JOIN KHACHANG KH ON DDH.MA_KH = KH.MA_KH
WHERE DDH.NOI_GIAOHANG = KH.DIACHI;

INSERT INTO KHACHANG
VALUES
('KH05', N'Công ty Alpha', N'Nguyễn Văn A', N'123 Đường A, Quận 1', 'alpha@email.com', '0901234567', '0281234567'),
('KH06', N'Công ty Beta', N'Lê Thị B', N'456 Đường B, Quận 3', 'beta@email.com', '0902345678', '0282345678'),
('KH07', N'Công ty Gamma', N'Trần Văn C', N'789 Đường C, Quận 5', 'gamma@email.com', '0903456789', '0283456789');

INSERT INTO DON_DATHANG
VALUES
('HD03', 'KH05','NV04', '2025-04-01', '2025-04-29','2025-04-29', N'123 Đường A, Quận 1'),
('HD04', 'KH06','NV06', '2025-04-02', '2025-04-28', '2025-04-28',N'456 Đường B, Quận 3'),
('HD05', 'KH07', 'NV05','2025-04-03', '2025-04-28','2025-04-29', N'789 Đường C, Quận 5');


