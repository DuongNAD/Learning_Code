CREATE DATABASE QLY_DU_AN

USE QLY_DU_AN

CREATE TABLE NHAN_VIEN(
	MA_NV VARCHAR(5) NOT NULL,
	HOTEN NVARCHAR(225) NOT NULL,
	NGAYSINH DATE NOT NULL,
	GT NVARCHAR(10) NOT NULL,
	MA_P VARCHAR(5) NOT NULL,
	LUONG DECIMAL(10,2) NOT NULL,
)

CREATE TABLE PHONG(
	MA_P VARCHAR(5) NOT NULL,
	TEN_PHONG NVARCHAR(50) NOT NULL,
)

CREATE TABLE DIA_DIEM_DV(	
	MA_DV VARCHAR(5) NOT NULL,
	DIA_DIEM NVARCHAR(225) NOT NULL,
)

CREATE TABLE DU_AN(
	MA_DA VARCHAR(5) NOT NULL,
	TEN_DA NVARCHAR(50) NOT NULL,
)
ALTER TABLE DU_AN
ADD 
	DIADIEM_DA NVARCHAR(225) NOT NULL,
	MA_DV VARCHAR(5) NOT NULL;

CREATE TABLE CHAM_CONG(
	MA_NV VARCHAR(5) NOT NULL,
	MA_DA VARCHAR(5) NOT NULL,
	SO_GIO INT,
)

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT PK_NHAN_VIEN
PRIMARY KEY (MA_NV)

ALTER TABLE DU_AN
ADD CONSTRAINT PK_DU_AN
PRIMARY KEY (MA_DA)

ALTER TABLE CHAM_CONG
ADD CONSTRAINT PK_CHAM_CONG
PRIMARY KEY (MA_NV,MA_DA)

ALTER TABLE PHONG
ADD CONSTRAINT PK_PHONG
PRIMARY KEY (MA_P)

ALTER TABLE DIA_DIEM_DV
ADD CONSTRAINT PK_DIA_DIEM_DV
PRIMARY KEY (MA_DV)

ALTER TABLE CHAM_CONG
ADD CONSTRAINT FK_MA_NV
FOREIGN KEY (MA_NV) REFERENCES NHAN_VIEN (MA_NV)

ALTER TABLE CHAM_CONG
ADD CONSTRAINT FK_MA_DA
FOREIGN KEY (MA_DA) REFERENCES DU_AN (MA_DA)

ALTER TABLE DU_AN
ADD CONSTRAINT FK_MA_DV
FOREIGN KEY (MA_DV) REFERENCES DIA_DIEM_DV (MA_DV)

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT FK_MA_P
FOREIGN KEY (MA_P) REFERENCES PHONG (MA_P)

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT CK_NGAYSINH
CHECK (NGAYSINH < CAST(GETDATE () AS DATE))

ALTER TABLE NHAN_VIEN
ADD CONSTRAINT CK_LUONG
CHECK (LUONG >= 0)

ALTER TABLE CHAM_CONG
ADD CONSTRAINT CK_SO_GIO
CHECK (SO_GIO>=0)


INSERT INTO NHAN_VIEN VALUES
	('01','Nguyễn Văn Hà','1980-04-30','Nữ','P1','5000000'),
	('02','Hoàng Lê Chi','1990-3-28','Nữ','P2','1500000'),
	('03','Nguyễn Quang Tèo','1988-08-17','Nam','P2','2000000'),
	('04','Lê Thu Hà','1987-09-18','Nữ','P3','3000000'),
	('05','Trần Thị Hiền','1986-05-15','Nữ','P1','4000000'),
	('06','Đặng Thị Thanh Phương','1989-04-02','Nữ','P3','2500000');

INSERT INTO PHONG VALUES 
	('P1','Hành chính quản trị'),
	('P2','Kỹ thuật'),
	('P3','Giám đốc');

INSERT INTO DIA_DIEM_DV VALUES
	('P1','2 Lê Lợi'),
	('P2','3 Hoàng Quốc Việt'),
	('P3','4 Nguyễn Trãi');

INSERT INTO DU_AN VALUES
	('D1','Phần mềm A','Bộ Thủy Lợi','P3'),
	('D2','Mạng B','UBND Từ Liêm','P1'),
	('D3','Agent C','TT khí tượng thủy văn HN','P2');

INSERT INTO CHAM_CONG VALUES
	('01','D1','10'),
	('02','D3','2'),
	('03','D1','8'),
	('01','D2','4'),
	('05','D2','5'),
	('06','D3','7'),
	('06','D2','3'),
	('03','D3','12'),
	('04','D1','5'),
	('06','D1','8');

DELETE FROM CHAM_CONG WHERE MA_NV = '03';
DELETE FROM NHAN_VIEN WHERE HOTEN  = 'Nguyễn Quang Tèo';

UPDATE NHAN_VIEN SET LUONG = LUONG + LUONG*0.05; 

UPDATE NHAN_VIEN SET LUONG = LUONG + 0.05*LUONG
	WHERE MA_P = 'P3';

DELETE FROM CHAM_CONG WHERE MA_NV IN ('05','06','07');
DELETE FROM NHAN_VIEN WHERE MA_NV IN ('05','06','07');

DELETE FROM CHAM_CONG
WHERE MA_NV IN (
	SELECT MA_NV 
	FROM NHAN_VIEN
	WHERE MA_P IN (
		SELECT MA_P
		FROM PHONG 
		WHERE TEN_PHONG = 'Hành chính quản trị'
		)
	);

UPDATE NHAN_VIEN SET LUONG = LUONG + LUONG *0.1
WHERE MA_NV = (
	SELECT TOP 1 MA_NV
	FROM CHAM_CONG
	GROUP BY MA_NV
	ORDER BY SUM(SO_GIO) DESC
	);

SELECT MA_NV, HOTEN,LUONG FROM NHAN_VIEN WHERE LUONG > 16000

SELECT MA_NV,HOTEN,LUONG FROM NHAN_VIEN WHERE LUONG BETWEEN 16000 AND 30000

SELECT * FROM NHAN_VIEN WHERE NGAYSINH >= '1990-01-01'

